name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]

jobs:
  test-python:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          cd python
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Lint with ruff
        run: |
          cd python
          ruff check src/ tests/
      
      - name: Type check with mypy
        run: |
          cd python
          mypy src/prompt_versioning
        continue-on-error: true
      
      - name: Run tests
        run: |
          cd python
          pytest tests/ -v --cov=prompt_versioning --cov-report=xml
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./python/coverage.xml
          flags: python-${{ matrix.python-version }}
  
  test-typescript:
    name: Test TypeScript (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['18', '20']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Install dependencies
        run: |
          cd typescript
          npm ci
      
      - name: Lint
        run: |
          cd typescript
          npm run lint
        continue-on-error: true
      
      - name: Build
        run: |
          cd typescript
          npm run build
      
      - name: Run tests
        run: |
          cd typescript
          npm test
        continue-on-error: true
  
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-python, test-typescript]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Python package
        run: |
          cd python
          pip install -e .
      
      - name: Install TypeScript package
        run: |
          cd typescript
          npm ci
          npm run build
      
      - name: Test CLI
        run: |
          promptvc --version
          promptvc init
          echo 'system: "Test"' > test.yaml
          promptvc commit -m "Test" -f test.yaml
          promptvc log
      
      - name: Test Python API
        run: |
          python << EOF
          from prompt_versioning.core import PromptRepository
          repo = PromptRepository.init("test-repo")
          commit = repo.commit("Test", {"system": "Test"})
          print(f"Created commit: {commit.hash}")
          versions = repo.log()
          assert len(versions) == 1
          print("âœ“ Python API test passed")
          EOF
  
  publish-python:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [test-python, integration-test]
    if: github.event_name == 'release'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      - name: Build package
        run: |
          cd python
          python -m build
      
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd python
          twine upload dist/*
  
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [test-typescript, integration-test]
    if: github.event_name == 'release'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install dependencies
        run: |
          cd typescript
          npm ci
      
      - name: Build
        run: |
          cd typescript
          npm run build
      
      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd typescript
          npm publish
